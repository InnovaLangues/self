tinymce.PluginManager.add("selffuriganaAdd", 
	function (t) {
	    t.addButton('selffuriganaAdd', {
	    	text: 'Add Furigana',
	        icon: false,
			onclick : function(v) {
				var sel_text = 0;
				var editor  = tinyMCE.activeEditor;
				
				if (editor.selection.getContent()) {
				    content = editor.selection.getContent();
				    sel_text = 1;
				} else {
				    content = editor.getContent();
				}
				
				var furigana = prompt("Insert Furigana", "");
				
				if(furigana){
					t.execCommand('mceInsertContent', false, '<ruby><rb>'+content+'</rb><rt>'+furigana+'</rt></ruby>');
					
					var endContent = $(editor.getContent());
					$('ruby', endContent).each(function(){
						var plainText = $('rb', $(this)).text();
						if( $('rt', $(this)).length < 1 ) {
							$(this).closest('ruby').before(plainText).remove();
							var newHtml = '';
							endContent.each(function(index,value) {
								newHtml += $(value).clone().wrap('<p>').parent().html();
							});
							t.setContent(newHtml);
						}
					});
				}
			}
		});
	}
);